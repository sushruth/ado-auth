#!/usr/bin/env node
var Re=Object.create;var g=Object.defineProperty,Se=Object.defineProperties,ke=Object.getOwnPropertyDescriptor,Te=Object.getOwnPropertyDescriptors,Ee=Object.getOwnPropertyNames,J=Object.getOwnPropertySymbols,xe=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable;var Y=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,d=(e,t)=>{for(var r in t||(t={}))H.call(t,r)&&Y(e,r,t[r]);if(J)for(var r of J(t))we.call(t,r)&&Y(e,r,t[r]);return e},y=(e,t)=>Se(e,Te(t)),q=e=>g(e,"__esModule",{value:!0});var Oe=(e,t)=>{q(e);for(var r in t)g(e,r,{get:t[r],enumerable:!0})},_e=(e,t,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ee(t))!H.call(e,o)&&o!=="default"&&g(e,o,{get:()=>t[o],enumerable:!(r=ke(t,o))||r.enumerable});return e},p=e=>_e(q(g(e!=null?Re(xe(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var m=(e,t,r)=>new Promise((o,a)=>{var s=f=>{try{c(r.next(f))}catch(O){a(O)}},n=f=>{try{c(r.throw(f))}catch(O){a(O)}},c=f=>f.done?o(f.value):Promise.resolve(f.value).then(s,n);c((r=r.apply(e,t)).next())});Oe(exports,{AdoAuthApiResponseTypes:()=>B,PrepareTypes:()=>l,auth:()=>N,listenForTokenFromTheWebsite:()=>I,operate:()=>$,prepare:()=>P,readConfig:()=>M,refetch:()=>v,writeAdoRc:()=>u,writeNpmrc:()=>A,writeYarn2rc:()=>F});var w=p(require("chalk")),he=p(require("sade"));var G="0.2.3";var W=6e4,_=35287,C="https://ado-auth.vercel.app",h="54DC9EFD-680A-4B1E-8066-D669BC6A5D09",b=":_authToken=";var T=p(require("chalk")),E=p(require("os")),x=p(require("path"));var te=p(require("opener")),re=p(require("url"));var K=p(require("dayjs")),V=p(require("fs"));function u(e,t){V.default.writeFileSync(e,JSON.stringify(y(d({},t),{expires_on:(0,K.default)().add(Number(t.expires_in),"seconds").toISOString()}),null,"  "),"utf8")}var X=p(require("chalk")),Z=p(require("http")),ee=p(require("ora"));var z=p(require("chalk")),Q=class{constructor(){this.debugEnabled=!1;this.debugPrefix=z.default.gray("[ado-auth]");this.enableDebug=()=>{this.debugEnabled=!0};this.disableDebug=()=>{this.debugEnabled=!1};this.debug=(t,...r)=>{this.debugEnabled&&console.debug(this.debugPrefix,t,...r)}}},i=new Q;function R(e){return m(this,null,function*(){return new Promise((t,r)=>m(this,null,function*(){let o=[],a;e.on("data",s=>{o.push(s)}).on("end",()=>{a=JSON.parse(Buffer.concat(o).toString()),t(a||void 0)}).on("error",r)}))})}function I(e){let t=(0,ee.default)({isEnabled:i.debugEnabled,prefixText:i.debugPrefix});return new Promise((r,o)=>{let a=Z.default.createServer((n,c)=>m(this,null,function*(){if(!n.method)return c.end();if(c.setHeader("Access-Control-Allow-Origin",e.host),c.setHeader("Access-Control-Allow-Methods","POST, OPTIONS"),c.setHeader("Access-Control-Allow-Headers","content-type"),/POST/i.test(n.method)){let f=yield R(n);if(f&&f.access_token)return c.setHeader("Content-Type","application/json"),r(f),clearTimeout(s),c.end(JSON.stringify({status:"OK"})),t.succeed("Received the token"),a.close()}return c.writeHead(200),c.end()})),s=setTimeout(()=>(t.fail("Could not retrieve token within 60 seconds"),o(new Error("Token retrieval took too long")),a.close()),W);i.debug("Started server at",X.default.bold.green(`http://localhost:${e.port}`)),a.listen(e.port),t.start("listening to POST request from the ado-auth site")})}function Ie(e=h,t,r){let o=new re.URL(t);return o.pathname="/api/auth",`https://app.vssps.visualstudio.com/oauth2/authorize?client_id=${e}&response_type=Assertion&scope=vso.packaging&redirect_uri=${o.href}&state=${encodeURIComponent(`{"port":"${r}"}`)}`}function N(e,t){return m(this,null,function*(){let r=Ie(t.clientId,t.host,t.port);(0,te.default)(r);let o=yield I(t);return o.access_token&&o.refresh_token&&o.expires_in?u(e,o):console.error("Something went wrong while fetching refresh token"),o})}var se=p(require("ora")),ae=p(require("url"));var oe=p(require("https")),ne=p(require("url"));function ie(e,t,r){return m(this,null,function*(){let o=JSON.stringify(r),a=new ne.URL(e),s={hostname:a.hostname,port:443,path:a.pathname,method:t,headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(o)}};return new Promise(n=>{oe.default.request(s,c=>m(this,null,function*(){let f=yield R(c);n(f)})).end(o)})})}function v(e,t,r){return m(this,null,function*(){let o=new ae.URL(r.host);o.pathname="api/refresh",i.debug(`Calling ${o.href} to refresh token`);let a=(0,se.default)({text:"Refetching token",prefixText:i.debugPrefix,isEnabled:i.debugEnabled}).start(),s=yield ie(o.href,"POST",{token:e.refresh_token,port:r.port});if((s==null?void 0:s.code)==="SUCCESS")return u(t,s.body),a.succeed("Received refreshed token succesfully."),s.body;a.fail("Something went wrong while fetching refresh token"),i.debug(s)})}var D=p(require("dayjs")),U=p(require("fs"));var l;(function(o){o[o.refetch=0]="refetch",o[o.fetch=1]="fetch",o[o.noop=2]="noop"})(l||(l={}));function P(e){if(U.default.existsSync(e)){let t=U.default.readFileSync(e,"utf-8");try{let r=JSON.parse(t);return(0,D.default)(r.expires_on).isAfter((0,D.default)().subtract(1,"minute"))?{type:l.noop,data:r}:{type:l.refetch,data:r}}catch(r){r instanceof Error&&console.warn(r.message)}}return{type:l.fetch}}var pe=p(require("chalk")),S=p(require("fs")),ce=p(require("os")),me=p(require("path"));function A({npmrcPath:e,registries:t,token:r}){let o="";if(i.debug(`${t.size} registries to be updated`),S.default.existsSync(e)){i.debug("found .npmrc in home directory");let a=S.default.readFileSync(e,"utf-8");for(let s of a.split(/\n/))if(/^\/\//.test(s)){let[n]=s.split(b),c=[...t].find(f=>f===n);c?(i.debug(`Adding a token to the "${c}" entry`),o+=n+b+r.access_token+`
`,t.delete(c)):o+=s+`
`}}else i.debug("No .npmrc in home directory");for(let a of t.values())i.debug(`Adding a new entry "${a}" with token`),t.delete(a),o+=a+b+(r==null?void 0:r.access_token)+`
`;o&&(i.debug(pe.default.green("Writing ~/.npmrc")),S.default.writeFileSync(me.default.resolve(ce.default.homedir(),".npmrc"),o))}var fe=p(require("chalk")),k=p(require("fs")),j=p(require("js-yaml")),le=p(require("os")),de=p(require("path"));function F({registries:e,token:t,yarnrcPath:r}){let o={npmRegistries:{}};if(k.default.existsSync(r)){if(i.debug("Found .yarnrc.yml in home directory"),o=j.default.load(k.default.readFileSync(r,"utf-8")),o.npmRegistries||(o.npmRegistries={}),o&&typeof o=="object")for(let n of e){let c=o.npmRegistries[n];c&&(i.debug(`Adding a token to the "${n}" entry`),c.npmAuthToken=t.access_token,e.delete(n))}}else i.debug("No .yarnrc.yml found in home directory");let a=e.size?[...e].reduce((n,c)=>({npmRegistries:y(d({},n.npmRegistries),{[c]:{npmAlwaysAuth:!0,npmAuthToken:t.access_token}})}),{npmRegistries:{}}):{npmRegistries:{}},s=j.default.dump({npmRegistries:d(d({},a.npmRegistries),o.npmRegistries)});s&&(i.debug(fe.default.green("Writing ~/.yarnrc.yml")),k.default.writeFileSync(de.default.resolve(le.default.homedir(),".yarnrc.yml"),s))}var L=p(require("child_process"));var Ne=/^(https?)?:?\/\/registry\.(yarnpkg|npmjs)\.(com|org).*/i,ge={npm:"npm config get registry",yarn:"yarn config get registry",yarn2:"yarn config get npmRegistryServer"};function ue(e){var o,a;let t="",r=e;if(e==="yarn"){let n=((o=(0,L.execSync)("yarn -v",{encoding:"utf8"}))==null?void 0:o.trim()).match(/(\d+)\.*/i);Number(n==null?void 0:n[1])>=2&&(r="yarn2")}try{t=(a=(0,L.execSync)(ge[r],{encoding:"utf8",cwd:process.cwd()}))==null?void 0:a.trim().replace(/^https?:/,""),(Ne.test(t)||/undefined/i.test(t))&&(t="")}catch(s){i.debug(`Running "${ge[r]}" resulted in an error - `,s)}return t?i.debug(`${r} config contains this registry -> `,t):i.debug(`No custom ${r} registry found.`),t}function M(){let e;try{e=ue("npm")}catch(r){r instanceof Error&&i.debug("running npm failed - ",r.message)}let t;try{t=ue("yarn")}catch(r){r instanceof Error&&i.debug("running yarn failed - ",r.message)}return new Set([...ye(e),...ye(t)].filter(Boolean))}function ye(e){if(!e)return[];let t=e.replace(/\/registry\/?$/im,"/");return[t,t+"registry/"]}function $(e){return m(this,null,function*(){i.debug("Trying to get registry settings from npm and yarn");let t=M();if(!t.size)return i.debug("No custom registries found. Skipping ado-auth");let r=x.default.resolve(E.default.homedir(),".ado-authrc.json"),o=x.default.resolve(E.default.homedir(),".npmrc"),a=x.default.resolve(E.default.homedir(),".yarnrc.yml"),s=P(r),n;s.type===l.fetch?(i.debug(T.default.bold.magenta("Trying to get auth token")),n=yield N(r,e)):s.type===l.refetch?(i.debug(T.default.bold.magenta("Trying to refetch auth token")),n=yield v(s.data,r,e)):s.type===l.noop&&(i.debug(T.default.bold.green("Valid token exists")),n=s.data),n&&(A({npmrcPath:o,token:n,registries:new Set(t)}),F({yarnrcPath:a,token:n,registries:new Set(t)}))})}var B;(function(n){n.NO_RESULT="NO_RESULT",n.NO_TOKENS="NO_TOKENS",n.MISSING_CODE="MISSING_CODE",n.MISSING_SECRET="MISSING_SECRET",n.ADO_REQUEST_ERROR="ADO_REQUEST_ERROR",n.SUCCESS="SUCCESS"})(B||(B={}));var be=(0,he.default)("ado-auth",!0).version(G).option("--host","On-premises url (including protocol) for the tool ado-auth api",C).option("-p, --port","localhost listening port to use for ado-auth api",_).option("-c, --clientid","vistualstudio.com app client ID to use to authenticate").option("-d, --debug","show debug logs",!1);be.action(e=>m(void 0,null,function*(){e.debug&&i.enableDebug(),e.clientId?i.debug("Using client id - ",w.default.bold(e.clientId)):e.clientId=h,e.host!==C&&i.debug("Using cusotm host for authentication - ",w.default.bold(e.host)),e.port!==_.toString()&&i.debug("Using custom port for auth callback - ",w.default.bold(e.port)),yield $(e)}));require.main===module&&!process.env.CI&&be.parse(process.argv);0&&(module.exports={AdoAuthApiResponseTypes,PrepareTypes,auth,listenForTokenFromTheWebsite,operate,prepare,readConfig,refetch,writeAdoRc,writeNpmrc,writeYarn2rc});
